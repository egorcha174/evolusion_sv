# TECH_SPEC — Evolusion (SvelteKit dashboard for Home Assistant)

## 0. Назначение документа

Этот документ — единое целеуказание для разработки: что строим, какие ограничения, критерии готовности и «жёсткий TO‑DO».
Документ написан для разработки проекта с нуля (без привязки к старым кодовым базам).

---

## 1. Цель проекта

Создать независимый веб‑дашборд для Home Assistant:

- Надёжное подключение к HA по WebSocket (connect/auth/reconnect).
- Просмотр сущностей и базовое управление (минимум: toggle и вызов сервисов).
- Главная страница‑дашборд с сеткой и карточками.
- Стабильность, предсказуемость и удобство для пользователя важнее количества функций.

## 2. Не‑цели (чтобы не расползаться)

- Не реализуем «всё сразу»: только поэтапно, маленькими шагами.
- Не внедряем тяжёлые фичи до MVP (плагины, маркетплейсы, сложный визуальный редактор).
- Не меняем фундаментальные решения без фиксации в журнале и обновления этого TECH_SPEC.

---

## 3. Ограничение: суточные лимиты AI Studio

Из‑за суточных лимитов разработки с агентом нужен режим, в котором каждый шаг завершает «единицу смысла» и фиксируется в журнале.
Цель — чтобы после остановки (лимиты/ошибка/время) было ясно:

1. что сделано,
2. что проверено,
3. что делать дальше.

### 3.1. Обязательная таблица изменений проекта (Project Log)

В репозитории ведётся файл:

- `docs/PROJECT_LOG.md`

Формат: Markdown‑таблица, одна строка = один шаг (completed/partial/rolled_back).

Колонки (минимум):

- Date (UTC)
- task_id
- step_id
- Title
- Goal (1–2 предложения)
- Files changed (список путей через запятую)
- Verification (команды + результат: pass/fail)
- Status (completed | partial | rolled_back)
- Next step (конкретная следующая цель)
- Notes (важные детали/ограничения)

Правило: шаг НЕ считается сделанным, пока не добавлена строка в `docs/PROJECT_LOG.md`.

### 3.2. Anti-loop (защита от зацикливания)

Чтобы избежать бесконечного повторения одного и того же шага:

- У каждого шага есть `step_id`.
- Максимум 2 попытки на один `step_id`.

Если после 2 попыток не достигнут DoD:

- шаг фиксируется как `partial`;
- в Notes записываются: симптом, гипотеза, что уже пробовали, что нужно от капитана;
- работа по этому шагу прекращается до решения капитаном (изменить план/приоритет/обойти/разбить на меньшие шаги).

---

## 4. Технологический стек (строго)

- Framework: SvelteKit (обязательно).
- Svelte: версия 5.
- Language: TypeScript.

Запрещено в кодовой базе:

- React, JSX, React hooks, Zustand.

---

## 5. Архитектура и структура каталогов

Ориентир на доменную структуру:

- `src/routes/`
  - страницы приложения
- `src/domains/ha/`
  - `api.ts` (HA WebSocket client)
  - `store.ts` (состояние HA: connection + entities)
  - `contracts/` (контракты сообщений/типизация payload)
  - `crypto.ts` (криптография: ключи/шифрование)
  - `storage.ts` (безопасное хранение persisted данных)
- `src/domains/app/`
  - глобальные настройки / роутинг‑состояние / app store
- `src/domains/ui/`
  - общие UI компоненты (layout, modals, controls)
  - `theme/` (система тем: store, utils, defaults)
- `src/lib/`
  - `types.ts`, helpers, utils

Ограничения качества:

- Любой файл ≤ 1000 строк (при превышении — декомпозиция).

---

## 6. Серверная модель: сначала один сервер, но проектируем под несколько

### 6.1. MVP: один сервер

На MVP приложение поддерживает один «активный сервер»:

- подключение/переподключение,
- хранение параметров,
- работа списков и управления.

### 6.2. Проектирование с оглядкой на мультисерверность

Даже при UI «один сервер», внутренние модели и слои должны позволять расширение:

- ServerConfig (потенциально коллекция)
- ActiveServerId/ActiveServerKey
- Привязка состояния HA к активному серверу (в будущем — к конкретному serverId)

Важно: на MVP не реализуем полноценный UI мультисерверности, но не делаем архитектурных «закладок», которые это заблокируют.

---

## 7. Интеграция с Home Assistant

### 7.1. Подключение

- WebSocket connect/auth/reconnect.
- Явные состояния: `disconnected` / `connecting` / `connected` / `error`.

### 7.2. Данные

- Получение текущих состояний (entities/states).
- Подписки на обновления состояния (реалтайм) и обновление store.
- Для UI предоставлять удобные derived‑данные/селекторы, чтобы компоненты не парсили HA «на месте».

---

## 8. Безопасность и хранение данных

### 8.1. Что храним

- Параметры сервера (url, name и т.п.)
- Токен доступа
- UI настройки (тема, сетка, раскладка)
- Последнее выбранное состояние (минимально)

### 8.2. Как храним

- Все секреты (url+token) хранятся в localStorage только в зашифрованном виде.
- `crypto.ts` отвечает за шифрование/дешифрование; `storage.ts` — за чтение/запись и миграции.
- Рекомендуемый алгоритм: AES-GCM.
- Должна быть описана процедура восстановления/смены ключа без «поломки UI».

UX‑правило: приложение не должно подвисать из‑за чтения/парсинга/дешифрования persisted‑данных.

---

## 9. UI: страницы и компоненты

### 9.1. Страницы (routes)

Минимальный набор:

- Dashboard (главная)
- All Entities
- All Devices
- History
- Helpers
- Settings

### 9.2. Компоненты

Минимум для MVP:

- Sidebar
- Header / DashboardHeader
- AllEntities list component (таблично/списком)
- Device/Entity row/card (минимальная)
- Общие элементы статуса: Loading/Empty/Error

После MVP:

- DashboardGrid (сетка)
- Drag-and-drop
- DeviceCard v2
- WeatherWidget / BatteryWidgetCard
- Модалки настроек/шаблонов

---

## 10. Definition of Done (DoD) для каждого шага

Шаг считается выполненным только если:

1. TypeScript check: PASS
2. Lint: PASS
3. Unit tests: PASS
4. Build: PASS
5. Smoke E2E: PASS
   - открыть главную страницу
   - увидеть базовый UI (не пустой белый экран)
6. Contract tests для HA API (на мок WebSocket): PASS

И в `docs/PROJECT_LOG.md` добавлена строка с результатом.

---

## 11. Процесс работы с агентом (Google AI Studio)

### 11.1. Правило «одна задача — один шаг»

Один шаг = одна атомарная цель и ограниченный набор файлов (идеально 1–3).

### 11.2. План до действия (обязателен)

Перед изменениями агент обязан выдать `task-plan.json` (или текстовый блок плана):

- task_id (формат: `agent-task-YYYYMMDD-NNNN`)
- step_id (например: `e1-02a`)
- title, goal
- files: create/modify/delete
- patches: diff или псевдо-diff
- verification: команды для DoD
- risk: что может сломаться
- rollback: как откатить

### 11.3. Git workflow

- Ветка: `agent/<task_id>`
- Коммиты: маленькие и понятные
- PR: обязателен
- Merge в main: только после ревью и прохождения CI

---

## 12. Жёсткий TO‑DO (этапы)

> Любая задача должна быть атомарной и проверяемой по DoD.

### Этап 0 — Фундамент и дисциплина

- E0-01: Добавить docs/TECH_SPEC.md (этот документ)
- E0-02: Добавить docs/PROJECT_LOG.md (таблица шагов)
- E0-03: Базовые скрипты: check/lint/test/build
- E0-04: Минимальный smoke e2e (Playwright) для главной страницы

### Этап 1 — Один сервер + HA ядро (железно)

- E1-01: Страница Settings: ввод url/token + тест подключения
- E1-02: HA WebSocket client (connect/auth/reconnect)
- E1-03: HA store: connection state + entities (get states + updates)
- E1-04: Экран All Entities: список, поиск, фильтры по домену
- E1-05: Базовые действия (toggle/call-service) + обработка ошибок
- E1-06: Безопасное хранение (crypto/storage) без лагов и потери данных
- E1-07: Mock WebSocket server + contract tests

### Этап 2 — Проектирование под мультисерверность (без полного UI)

- E2-01: Модель ServerConfig + ActiveServerId в домене app
- E2-02: Адаптация ha домена к serverId (внутренне), UI всё ещё один сервер

### Этап 3 — Дашборд и карточки

- E3-01: DashboardGrid (сетка)
- E3-02: Drag-and-drop (минимально)
- E3-03: DeviceCard v1 на derived‑данных ha store
- E3-04: Persist layout (стабильно, без подвисаний)

### Этап 4 — Полировка и удобство

- E4-01: Производительность (устранение подвисаний)
- E4-02: Улучшение UX ошибок/статусов
- E4-03: Минимальная документация для пользователя (как подключить HA)
- E4-04: Система тем (light/dark, custom palettes, CSS vars)

---

## 13. Архитектурный контракт (Frozen Core)

На основании ревью (T-ARCH-01), текущая структура фиксируется как базовое ядро.

### 13.1. Замороженные границы (Frozen Boundaries)

Следующие домены имеют фиксированную ответственность. Перенос логики между ними запрещён без RFC (Major Refactoring):

1. **`src/domains/app/`**: Ядро сессии.
   - Отвечает за: Глобальное время (`time.ts`), активную вкладку (`tabsStore.ts`), выбор сервера, загрузку layout.
   - **Не лезет в**: Прямое управление данными HA или рендеринг конкретных карточек.

2. **`src/domains/ha/`**: Слой данных (Backend in Frontend).
   - Отвечает за: WebSocket транспорт (`api.ts`), кэширование сущностей (`store.ts`), батчинг обновлений.
   - **Не лезет в**: UI компоненты (никакого svelte-кода, только stores/ts).

3. **`src/domains/ui/editor/`**: Подсистема редактирования.
   - Отвечает за: Геометрию, Drag-n-Drop, Undo/Redo, сессию редактирования.
   - Является независимым "продуктом в продукте".

4. **`src/themes/`**: Контракт визуала.
   - Любая тема — это JSON-пресет + строгая типизация TypeScript.
   - Хардкод цветов в компонентах запрещён (только через CSS vars из темы).

### 13.2. Разрешённые направления эволюции (Open for Extension)

1. **Оптимизация**:
   - Внутренности `ha/store.ts` (селекторы, индексы) можно переписывать для performance.
   - `VirtualList` и стратегии рендеринга.
2. **Расширение UI**:
   - Новые виджеты в `domains/ui/widgets`.
   - Новые типы карточек.
3. **Плагины**:
   - Добавление новых провайдеров погоды в `lib/weather`.
   - Добавление языков в `lib/i18n`.
   - Добавление пресетов тем.

Этот контракт действует начиная с этапа E4/E5.
