var ce=Object.defineProperty;var le=(t,e,n)=>e in t?ce(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var m=(t,e,n)=>le(t,typeof e!="symbol"?e+"":e,n);import{Z as fe,n as O,_ as ue,a as Q,b as de,$ as he,a0 as pe,a1 as j,a2 as I,y as W,a3 as L,a4 as ge,a5 as ve,a6 as ee,o as _e,a7 as z,a8 as b,a9 as q,aa as me,ab as ne,ac as we,ad as U,ae as Ce,af as Ee,ag as be,ah as Se,ai as ie,aj as re,ak as F,al as ye,am as Ae,an as ke,ao as Me,ap as ae,C as Ne,aq as Te,ar as oe,as as Pe,at as Re}from"./MIkDUfiV.js";function ze(t,e){return e}function xe(t,e,n){for(var s=[],f=e.length,c,l=e.length,p=0;p<f;p++){let w=e[p];re(w,()=>{if(c){if(c.pending.delete(w),c.done.add(w),c.pending.size===0){var u=t.outrogroups;J(U(c.done)),u.delete(c),u.size===0&&(t.outrogroups=null)}}else l-=1},!1)}if(l===0){var a=s.length===0&&n!==null;if(a){var h=n,r=h.parentNode;Ae(r),r.append(h),t.items.clear()}J(e,!a)}else c={pending:new Set(e),done:new Set},(t.outrogroups??(t.outrogroups=new Set)).add(c)}function J(t,e=!0){for(var n=0;n<t.length;n++)ke(t[n],e)}var te;function Fe(t,e,n,s,f,c=null){var l=t,p=new Map,a=(e&ae)!==0;if(a){var h=t;l=O?I(Me(h)):h.appendChild(z())}O&&ue();var r=null,w=de(()=>{var o=n();return Ce(o)?o:o==null?[]:U(o)}),u,g=!0;function A(){i.fallback=r,Oe(i,u,l,e,s),r!==null&&(u.length===0?r.f&b?(r.f^=b,H(r,null,l)):ie(r):re(r,()=>{r=null}))}var N=fe(()=>{u=Q(w);var o=u.length;let T=!1;if(O){var P=he(l)===pe;P!==(o===0)&&(l=j(),I(l),W(!1),T=!0)}for(var C=new Set,k=_e,R=me(),v=0;v<o;v+=1){O&&L.nodeType===ge&&L.data===ve&&(l=L,T=!0,W(!1));var M=u[v],x=s(M,v),_=g?null:p.get(x);_?(_.v&&ee(_.v,M),_.i&&ee(_.i,v),R&&k.skipped_effects.delete(_.e)):(_=He(p,g?l:te??(te=z()),M,x,v,f,e,n),g||(_.e.f|=b),p.set(x,_)),C.add(x)}if(o===0&&c&&!r&&(g?r=q(()=>c(l)):(r=q(()=>c(te??(te=z()))),r.f|=b)),O&&o>0&&I(j()),!g)if(R){for(const[D,$]of p)C.has(D)||k.skipped_effects.add($.e);k.oncommit(A),k.ondiscard(()=>{})}else A();T&&W(!0),Q(w)}),i={effect:N,items:p,outrogroups:null,fallback:r};g=!1,O&&(l=L)}function Oe(t,e,n,s,f){var _,D,$,V,Y,B,X,Z,G;var c=(s&Te)!==0,l=e.length,p=t.items,a=t.effect.first,h,r=null,w,u=[],g=[],A,N,i,o;if(c)for(o=0;o<l;o+=1)A=e[o],N=f(A,o),i=p.get(N).e,i.f&b||((D=(_=i.nodes)==null?void 0:_.a)==null||D.measure(),(w??(w=new Set)).add(i));for(o=0;o<l;o+=1){if(A=e[o],N=f(A,o),i=p.get(N).e,t.outrogroups!==null)for(const E of t.outrogroups)E.pending.delete(i),E.done.delete(i);if(i.f&b)if(i.f^=b,i===a)H(i,null,n);else{var T=r?r.next:a;i===t.effect.last&&(t.effect.last=i.prev),i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),y(t,r,i),y(t,i,T),H(i,T,n),r=i,u=[],g=[],a=r.next;continue}if(i.f&F&&(ie(i),c&&((V=($=i.nodes)==null?void 0:$.a)==null||V.unfix(),(w??(w=new Set)).delete(i))),i!==a){if(h!==void 0&&h.has(i)){if(u.length<g.length){var P=g[0],C;r=P.prev;var k=u[0],R=u[u.length-1];for(C=0;C<u.length;C+=1)H(u[C],P,n);for(C=0;C<g.length;C+=1)h.delete(g[C]);y(t,k.prev,R.next),y(t,r,k),y(t,R,P),a=P,r=R,o-=1,u=[],g=[]}else h.delete(i),H(i,a,n),y(t,i.prev,i.next),y(t,i,r===null?t.effect.first:r.next),y(t,r,i),r=i;continue}for(u=[],g=[];a!==null&&a!==i;)(h??(h=new Set)).add(a),g.push(a),a=a.next;if(a===null)continue}i.f&b||u.push(i),r=i,a=i.next}if(t.outrogroups!==null){for(const E of t.outrogroups)E.pending.size===0&&(J(U(E.done)),(Y=t.outrogroups)==null||Y.delete(E));t.outrogroups.size===0&&(t.outrogroups=null)}if(a!==null||h!==void 0){var v=[];if(h!==void 0)for(i of h)i.f&F||v.push(i);for(;a!==null;)!(a.f&F)&&a!==t.fallback&&v.push(a),a=a.next;var M=v.length;if(M>0){var x=s&ae&&l===0?n:null;if(c){for(o=0;o<M;o+=1)(X=(B=v[o].nodes)==null?void 0:B.a)==null||X.measure();for(o=0;o<M;o+=1)(G=(Z=v[o].nodes)==null?void 0:Z.a)==null||G.fix()}xe(t,v,x)}}c&&Ne(()=>{var E,K;if(w!==void 0)for(i of w)(K=(E=i.nodes)==null?void 0:E.a)==null||K.apply()})}function He(t,e,n,s,f,c,l,p){var a=l&Ee?l&be?ne(n):we(n,!1,!1):null,h=l&Se?ne(f):null;return{v:a,i:h,e:q(()=>(c(e,a??n,h??f,p),()=>{t.delete(s)}))}}function H(t,e,n){if(t.nodes)for(var s=t.nodes.start,f=t.nodes.end,c=e&&!(e.f&b)?e.nodes.start:n;s!==null;){var l=ye(s);if(c.before(s),s===f)return;s=l}}function y(t,e,n){e===null?t.effect.first=n:e.next=n,n===null?t.effect.last=e:n.prev=e}class De{constructor(e,n){m(this,"ws",null);m(this,"url");m(this,"token");m(this,"messageId",0);m(this,"subscriptions",new Map);m(this,"pendingCommands",new Map);m(this,"stateChangeCallbacks",new Set);m(this,"reconnectAttempts",0);m(this,"maxReconnectAttempts",5);m(this,"connectPromise",null);m(this,"forcedDisconnect",!1);this.url=this.formatUrl(e),this.token=n}formatUrl(e){const s=e.startsWith("https")?"wss://":"ws://";let f=e.replace(/^https?:\/\//,"").replace(/\/$/,"");return`${s}${f}/api/websocket`}async connect(){if(this.forcedDisconnect=!1,!this.isConnected())return new Promise((e,n)=>{this.connectPromise={resolve:e,reject:n};try{this.ws=new WebSocket(this.url)}catch(s){this._onError(new Event("error")),n(s);return}this.ws.onopen=this._onOpen.bind(this),this.ws.onmessage=this._onMessage.bind(this),this.ws.onerror=this._onError.bind(this),this.ws.onclose=this._onClose.bind(this)})}async disconnect(){this.forcedDisconnect=!0,this.ws&&(this.ws.close(),this.ws=null)}isConnected(){return this.ws!==null&&this.ws.readyState===1}async getStates(){return this._sendCommand({type:"get_states"})}async subscribe(e="state_changed"){return await this._sendCommand({type:"subscribe_events",event_type:e})}unsubscribe(e){this._send({type:"unsubscribe_events",subscription:e}).catch(console.error),this.subscriptions.delete(e)}async callService(e,n,s={}){await this._sendCommand({type:"call_service",domain:e,service:n,service_data:s})}onStateChange(e){this.stateChangeCallbacks.add(e)}async _sendCommand(e){if(!this.isConnected())throw new Error("Not connected");const n=++this.messageId,s={...e,id:n};return new Promise((f,c)=>{this.pendingCommands.set(n,{resolve:f,reject:c}),this.ws.send(JSON.stringify(s)),e.type==="subscribe_events"&&this.subscriptions.set(n,l=>{(e.event_type==="state_changed"||!e.event_type)&&this.stateChangeCallbacks.forEach(p=>p(l))})})}async _send(e){if(!this.isConnected())return;const n=++this.messageId,s={...e,id:n};this.ws.send(JSON.stringify(s))}_onOpen(){console.log("WS Open")}_onMessage(e){let n;try{n=JSON.parse(e.data)}catch(s){console.error("Failed to parse WS message",s);return}switch(n.type){case"auth_required":this._sendAuth();break;case"auth_ok":this.reconnectAttempts=0,this.connectPromise&&(this.connectPromise.resolve(null),this.connectPromise=null);break;case"auth_invalid":this.connectPromise&&(this.connectPromise.reject(new Error(n.message)),this.connectPromise=null),this.disconnect();break;case"result":this._handleResult(n);break;case"event":this._handleEvent(n);break}}_sendAuth(){const e={type:"auth",access_token:this.token};this.ws.send(JSON.stringify(e))}_handleResult(e){var s;const n=this.pendingCommands.get(e.id);n&&(e.success?e.result!==void 0?n.resolve(e.result):n.resolve(e.id):n.reject(new Error(((s=e.error)==null?void 0:s.message)||"Unknown error")),this.pendingCommands.delete(e.id))}_handleEvent(e){const n=this.subscriptions.get(e.id);n&&n(e.event)}_onError(e){console.error("WS Error",e),this.connectPromise&&(this.connectPromise.reject(new Error("WebSocket connection failed")),this.connectPromise=null)}_onClose(e){console.log("WS Close",e.code,e.reason),this.connectPromise&&(this.connectPromise.reject(new Error("Connection closed during handshake")),this.connectPromise=null),this.ws=null,this.pendingCommands.forEach(n=>n.reject(new Error("Connection closed"))),this.pendingCommands.clear(),this.forcedDisconnect||this._attemptReconnect()}_attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnect attempts reached");return}this.reconnectAttempts++;const e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);console.log(`Reconnecting in ${e}ms... (Attempt ${this.reconnectAttempts})`),setTimeout(()=>{this.connect().catch(n=>console.error("Reconnect failed",n))},e)}}const S=Pe({isConnected:!1,isLoading:!1,error:null,entities:new Map}),qe=oe(S,t=>Array.from(t.entities.values()));oe(S,t=>Array.from(t.entities.values()).filter(e=>e.state!=="unavailable"));let d=null;async function Je(t,e){d&&await $e(),S.update(n=>({...n,isLoading:!0,error:null}));try{d=new De(t,e),await d.connect();const n=await d.getStates();S.update(s=>{const f=new Map;return n.forEach(c=>{f.set(c.entity_id,se(c))}),{...s,isConnected:!0,entities:f}}),await d.subscribe("state_changed"),d.onStateChange(s=>{s.data.new_state&&Le(s.data.entity_id,se(s.data.new_state))})}catch(n){if(console.error("HA Connection failed:",n),S.update(s=>({...s,isConnected:!1,error:n.message||"Connection failed"})),d){try{await d.disconnect()}catch{}d=null}}finally{S.update(n=>({...n,isLoading:!1}))}}async function $e(){d&&(await d.disconnect(),d=null),S.update(t=>({...t,isConnected:!1,entities:new Map,error:null}))}function Le(t,e){S.update(n=>{const s=new Map(n.entities);return s.set(t,e),{...n,entities:s}})}async function Ue(t){if(!d||!d.isConnected())throw new Error("Not connected to Home Assistant");const n=Re(S).entities.get(t);if(!n)throw new Error(`Entity ${t} not found`);const s=t.split(".")[0];if(s==="light"||s==="switch")await d.callService(s,"toggle",{entity_id:t});else if(s==="cover")await d.callService(s,"toggle",{entity_id:t});else if(s==="input_boolean")await d.callService("input_boolean","toggle",{entity_id:t});else if(s==="lock"){const f=n.state==="locked"?"unlock":"lock";await d.callService("lock",f,{entity_id:t})}else if(s==="script")await d.callService("script","turn_on",{entity_id:t});else throw new Error(`Cannot toggle entity with domain: ${s}`)}function se(t){return{entity_id:t.entity_id,state:t.state,attributes:t.attributes,last_changed:t.last_changed,last_updated:t.last_updated,context:t.context}}export{qe as a,Je as b,$e as d,Fe as e,S as h,ze as i,Ue as t};
