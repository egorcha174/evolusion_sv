var ce=Object.defineProperty;var le=(t,e,n)=>e in t?ce(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var m=(t,e,n)=>le(t,typeof e!="symbol"?e+"":e,n);import{a2 as fe,q as O,a3 as ue,a as Z,b as de,a4 as he,a5 as pe,a6 as j,a7 as I,r as W,a8 as $,a9 as ve,aa as ge,ab as ee,Y as _e,ac as q,ad as b,ae as F,af as me,ag as ne,ah as we,ai as J,U as Ee,aj as Ce,ak as be,al as Se,am as ie,an as re,ao as z,ap as ye,aq as Ae,ar as ke,as as Me,at as ae,x as Ne,au as Te,av as oe,aw as xe,ax as Pe}from"./D78c_VIb.js";function qe(t,e){return e}function Re(t,e,n){for(var s=[],f=e.length,c,l=e.length,p=0;p<f;p++){let w=e[p];re(w,()=>{if(c){if(c.pending.delete(w),c.done.add(w),c.pending.size===0){var u=t.outrogroups;U(J(c.done)),u.delete(c),u.size===0&&(t.outrogroups=null)}}else l-=1},!1)}if(l===0){var a=s.length===0&&n!==null;if(a){var h=n,r=h.parentNode;Ae(r),r.append(h),t.items.clear()}U(e,!a)}else c={pending:new Set(e),done:new Set},(t.outrogroups??(t.outrogroups=new Set)).add(c)}function U(t,e=!0){for(var n=0;n<t.length;n++)ke(t[n],e)}var te;function ze(t,e,n,s,f,c=null){var l=t,p=new Map,a=(e&ae)!==0;if(a){var h=t;l=O?I(Me(h)):h.appendChild(q())}O&&ue();var r=null,w=de(()=>{var o=n();return Ee(o)?o:o==null?[]:J(o)}),u,v=!0;function A(){i.fallback=r,Oe(i,u,l,e,s),r!==null&&(u.length===0?r.f&b?(r.f^=b,H(r,null,l)):ie(r):re(r,()=>{r=null}))}var N=fe(()=>{u=Z(w);var o=u.length;let T=!1;if(O){var x=he(l)===pe;x!==(o===0)&&(l=j(),I(l),W(!1),T=!0)}for(var E=new Set,k=_e,P=me(),g=0;g<o;g+=1){O&&$.nodeType===ve&&$.data===ge&&(l=$,T=!0,W(!1));var M=u[g],R=s(M,g),_=v?null:p.get(R);_?(_.v&&ee(_.v,M),_.i&&ee(_.i,g),P&&k.skipped_effects.delete(_.e)):(_=He(p,v?l:te??(te=q()),M,R,g,f,e,n),v||(_.e.f|=b),p.set(R,_)),E.add(R)}if(o===0&&c&&!r&&(v?r=F(()=>c(l)):(r=F(()=>c(te??(te=q()))),r.f|=b)),O&&o>0&&I(j()),!v)if(P){for(const[D,L]of p)E.has(D)||k.skipped_effects.add(L.e);k.oncommit(A),k.ondiscard(()=>{})}else A();T&&W(!0),Z(w)}),i={effect:N,items:p,outrogroups:null,fallback:r};v=!1,O&&(l=$)}function Oe(t,e,n,s,f){var _,D,L,Y,V,B,X,G,K;var c=(s&Te)!==0,l=e.length,p=t.items,a=t.effect.first,h,r=null,w,u=[],v=[],A,N,i,o;if(c)for(o=0;o<l;o+=1)A=e[o],N=f(A,o),i=p.get(N).e,i.f&b||((D=(_=i.nodes)==null?void 0:_.a)==null||D.measure(),(w??(w=new Set)).add(i));for(o=0;o<l;o+=1){if(A=e[o],N=f(A,o),i=p.get(N).e,t.outrogroups!==null)for(const C of t.outrogroups)C.pending.delete(i),C.done.delete(i);if(i.f&b)if(i.f^=b,i===a)H(i,null,n);else{var T=r?r.next:a;i===t.effect.last&&(t.effect.last=i.prev),i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),y(t,r,i),y(t,i,T),H(i,T,n),r=i,u=[],v=[],a=r.next;continue}if(i.f&z&&(ie(i),c&&((Y=(L=i.nodes)==null?void 0:L.a)==null||Y.unfix(),(w??(w=new Set)).delete(i))),i!==a){if(h!==void 0&&h.has(i)){if(u.length<v.length){var x=v[0],E;r=x.prev;var k=u[0],P=u[u.length-1];for(E=0;E<u.length;E+=1)H(u[E],x,n);for(E=0;E<v.length;E+=1)h.delete(v[E]);y(t,k.prev,P.next),y(t,r,k),y(t,P,x),a=x,r=P,o-=1,u=[],v=[]}else h.delete(i),H(i,a,n),y(t,i.prev,i.next),y(t,i,r===null?t.effect.first:r.next),y(t,r,i),r=i;continue}for(u=[],v=[];a!==null&&a!==i;)(h??(h=new Set)).add(a),v.push(a),a=a.next;if(a===null)continue}i.f&b||u.push(i),r=i,a=i.next}if(t.outrogroups!==null){for(const C of t.outrogroups)C.pending.size===0&&(U(J(C.done)),(V=t.outrogroups)==null||V.delete(C));t.outrogroups.size===0&&(t.outrogroups=null)}if(a!==null||h!==void 0){var g=[];if(h!==void 0)for(i of h)i.f&z||g.push(i);for(;a!==null;)!(a.f&z)&&a!==t.fallback&&g.push(a),a=a.next;var M=g.length;if(M>0){var R=s&ae&&l===0?n:null;if(c){for(o=0;o<M;o+=1)(X=(B=g[o].nodes)==null?void 0:B.a)==null||X.measure();for(o=0;o<M;o+=1)(K=(G=g[o].nodes)==null?void 0:G.a)==null||K.fix()}Re(t,g,R)}}c&&Ne(()=>{var C,Q;if(w!==void 0)for(i of w)(Q=(C=i.nodes)==null?void 0:C.a)==null||Q.apply()})}function He(t,e,n,s,f,c,l,p){var a=l&Ce?l&be?ne(n):we(n,!1,!1):null,h=l&Se?ne(f):null;return{v:a,i:h,e:F(()=>(c(e,a??n,h??f,p),()=>{t.delete(s)}))}}function H(t,e,n){if(t.nodes)for(var s=t.nodes.start,f=t.nodes.end,c=e&&!(e.f&b)?e.nodes.start:n;s!==null;){var l=ye(s);if(c.before(s),s===f)return;s=l}}function y(t,e,n){e===null?t.effect.first=n:e.next=n,n===null?t.effect.last=e:n.prev=e}class De{constructor(e,n){m(this,"ws",null);m(this,"url");m(this,"token");m(this,"messageId",0);m(this,"subscriptions",new Map);m(this,"pendingCommands",new Map);m(this,"stateChangeCallbacks",new Set);m(this,"reconnectAttempts",0);m(this,"maxReconnectAttempts",5);m(this,"connectPromise",null);m(this,"forcedDisconnect",!1);this.url=this.formatUrl(e),this.token=n}formatUrl(e){const s=e.startsWith("https")?"wss://":"ws://";let f=e.replace(/^https?:\/\//,"").replace(/\/$/,"");return`${s}${f}/api/websocket`}async connect(){if(this.forcedDisconnect=!1,!this.isConnected())return new Promise((e,n)=>{this.connectPromise={resolve:e,reject:n};try{this.ws=new WebSocket(this.url)}catch(s){this._onError(new Event("error")),n(s);return}this.ws.onopen=this._onOpen.bind(this),this.ws.onmessage=this._onMessage.bind(this),this.ws.onerror=this._onError.bind(this),this.ws.onclose=this._onClose.bind(this)})}async disconnect(){this.forcedDisconnect=!0,this.ws&&(this.ws.close(),this.ws=null)}isConnected(){return this.ws!==null&&this.ws.readyState===1}async getStates(){return this._sendCommand({type:"get_states"})}async subscribe(e="state_changed"){return await this._sendCommand({type:"subscribe_events",event_type:e})}unsubscribe(e){this._send({type:"unsubscribe_events",subscription:e}).catch(console.error),this.subscriptions.delete(e)}async callService(e,n,s={}){await this._sendCommand({type:"call_service",domain:e,service:n,service_data:s})}onStateChange(e){this.stateChangeCallbacks.add(e)}async _sendCommand(e){if(!this.isConnected())throw new Error("Not connected");const n=++this.messageId,s={...e,id:n};return new Promise((f,c)=>{this.pendingCommands.set(n,{resolve:f,reject:c}),this.ws.send(JSON.stringify(s)),e.type==="subscribe_events"&&this.subscriptions.set(n,l=>{(e.event_type==="state_changed"||!e.event_type)&&this.stateChangeCallbacks.forEach(p=>p(l))})})}async _send(e){if(!this.isConnected())return;const n=++this.messageId,s={...e,id:n};this.ws.send(JSON.stringify(s))}_onOpen(){console.log("WS Open")}_onMessage(e){let n;try{n=JSON.parse(e.data)}catch(s){console.error("Failed to parse WS message",s);return}switch(n.type){case"auth_required":this._sendAuth();break;case"auth_ok":this.reconnectAttempts=0,this.connectPromise&&(this.connectPromise.resolve(null),this.connectPromise=null);break;case"auth_invalid":this.connectPromise&&(this.connectPromise.reject(new Error(n.message)),this.connectPromise=null),this.disconnect();break;case"result":this._handleResult(n);break;case"event":this._handleEvent(n);break}}_sendAuth(){const e={type:"auth",access_token:this.token};this.ws.send(JSON.stringify(e))}_handleResult(e){var s;const n=this.pendingCommands.get(e.id);n&&(e.success?e.result!==void 0?n.resolve(e.result):n.resolve(e.id):n.reject(new Error(((s=e.error)==null?void 0:s.message)||"Unknown error")),this.pendingCommands.delete(e.id))}_handleEvent(e){const n=this.subscriptions.get(e.id);n&&n(e.event)}_onError(e){console.error("WS Error",e),this.connectPromise&&(this.connectPromise.reject(new Error("WebSocket connection failed")),this.connectPromise=null)}_onClose(e){console.log("WS Close",e.code,e.reason),this.connectPromise&&(this.connectPromise.reject(new Error("Connection closed during handshake")),this.connectPromise=null),this.ws=null,this.pendingCommands.forEach(n=>n.reject(new Error("Connection closed"))),this.pendingCommands.clear(),this.forcedDisconnect||this._attemptReconnect()}_attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnect attempts reached");return}this.reconnectAttempts++;const e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);console.log(`Reconnecting in ${e}ms... (Attempt ${this.reconnectAttempts})`),setTimeout(()=>{this.connect().catch(n=>console.error("Reconnect failed",n))},e)}}const S=xe({isConnected:!1,isLoading:!1,error:null,entities:new Map}),Fe=oe(S,t=>Array.from(t.entities.values()));oe(S,t=>Array.from(t.entities.values()).filter(e=>e.state!=="unavailable"));let d=null;async function Ue(t,e){d&&await Le(),S.update(n=>({...n,isLoading:!0,error:null}));try{d=new De(t,e),await d.connect();const n=await d.getStates();S.update(s=>{const f=new Map;return n.forEach(c=>{f.set(c.entity_id,se(c))}),{...s,isConnected:!0,entities:f}}),await d.subscribe("state_changed"),d.onStateChange(s=>{s.data.new_state&&$e(s.data.entity_id,se(s.data.new_state))})}catch(n){if(console.error("HA Connection failed:",n),S.update(s=>({...s,isConnected:!1,error:n.message||"Connection failed"})),d){try{await d.disconnect()}catch{}d=null}}finally{S.update(n=>({...n,isLoading:!1}))}}async function Le(){d&&(await d.disconnect(),d=null),S.update(t=>({...t,isConnected:!1,entities:new Map,error:null}))}function $e(t,e){S.update(n=>{const s=new Map(n.entities);return s.set(t,e),{...n,entities:s}})}async function Je(t){if(!d||!d.isConnected())throw new Error("Not connected to Home Assistant");const n=Pe(S).entities.get(t);if(!n)throw new Error(`Entity ${t} not found`);const s=t.split(".")[0];if(s==="light"||s==="switch")await d.callService(s,"toggle",{entity_id:t});else if(s==="cover")await d.callService(s,"toggle",{entity_id:t});else if(s==="input_boolean")await d.callService("input_boolean","toggle",{entity_id:t});else if(s==="lock"){const f=n.state==="locked"?"unlock":"lock";await d.callService("lock",f,{entity_id:t})}else if(s==="script")await d.callService("script","turn_on",{entity_id:t});else throw new Error(`Cannot toggle entity with domain: ${s}`)}function se(t){return{entity_id:t.entity_id,state:t.state,attributes:t.attributes,last_changed:t.last_changed,last_updated:t.last_updated,context:t.context}}export{Fe as a,Ue as b,Le as d,ze as e,S as h,qe as i,Je as t};
