var O=Object.defineProperty;var T=(r,a,n)=>a in r?O(r,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[a]=n;var I=(r,a,n)=>T(r,typeof a!="symbol"?a+"":a,n);import{F as S,G as D}from"./DrE23S9z.js";import{d as E}from"./-3n6O5sP.js";const k={loadLayout(r){const n=S(E).tabs[r],t=new Map,s=new Map,e=(n==null?void 0:n.gridColumns)??8,o=(n==null?void 0:n.gridRows)??6;return n&&n.cards.forEach(i=>{t.set(i.id,{col:i.position.x,row:i.position.y,w:i.position.w,h:i.position.h}),s.set(i.id,i.entityId)}),{cards:t,entities:s,cols:e,rows:o}},saveLayout(r,a,n,t){var d;const e=((d=S(E).tabs[r])==null?void 0:d.cards)||[],o=new Map(e.map(c=>[c.id,c])),i=[];a.forEach((c,w)=>{const u=n.get(w);if(u){const f=o.get(w);let h=f==null?void 0:f.templateId;t&&t.has(w)&&(h=t.get(w)),i.push({id:w,entityId:u,position:{x:c.col,y:c.row,w:c.w,h:c.h},templateId:h})}}),E.replaceTabCards(r,i)}};class G{constructor(){I(this,"undoStack",[]);I(this,"redoStack",[]);I(this,"limit",100)}push(a){this.undoStack.push(a),this.undoStack.length>this.limit&&this.undoStack.shift(),this.redoStack=[]}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}undo(){const a=this.undoStack.pop();return a?(this.redoStack.push(a),a):null}redo(){const a=this.redoStack.pop();return a?(this.undoStack.push(a),a):null}clear(){this.undoStack=[],this.redoStack=[]}}const x=new G,b=.5;function M(r){return Math.round(r*2)/2}function R(r,a,n){return r.col>=0&&r.row>=0&&r.col+r.w<=a&&r.row+r.h<=n}function H(r,a){const n={x1:r.col*2,y1:r.row*2,x2:(r.col+r.w)*2,y2:(r.row+r.h)*2};for(const t of a){const s={x1:t.col*2,y1:t.row*2,x2:(t.col+t.w)*2,y2:(t.row+t.h)*2};if(n.x1<s.x2&&n.x2>s.x1&&n.y1<s.y2&&n.y2>s.y1)return!0}return!1}function P(r,a,n){return{...r,col:M(r.col+a),row:M(r.row+n)}}function W(r,a,n,t,s){const e={...r},o=M(n),i=M(t);if(a.includes("e")&&(e.w=Math.max(b,r.w+o)),a.includes("s")&&(e.h=Math.max(b,r.h+i)),a.includes("w")){const d=Math.max(b,r.w-o),c=r.w-d;e.col=r.col+c,e.w=d}if(a.includes("n")){const d=Math.max(b,r.h-i),c=r.h-d;e.row=r.row+c,e.h=d}return e.col=M(e.col),e.row=M(e.row),e.w=M(e.w),e.h=M(e.h),e}const v={enabled:!1,tabId:null,selectedCardId:null,showGridSettings:!1,isTemplateManagerOpen:!1,pointerOp:{kind:"idle"},gridMetrics:{halfUnitSizePx:0,cols:8,rows:6},drafts:new Map,templateOverrides:new Map,cardEntities:new Map,collision:!1};function z(){const{subscribe:r,set:a,update:n}=D(v);return{subscribe:r,update:n,openTemplateManager(){n(t=>({...t,isTemplateManagerOpen:!0}))},closeTemplateManager(){n(t=>({...t,isTemplateManagerOpen:!1}))},initSession(t){const{cards:s,entities:e,cols:o,rows:i}=k.loadLayout(t);n(d=>({...d,enabled:!0,tabId:t,drafts:s,templateOverrides:new Map,cardEntities:e,selectedCardId:null,showGridSettings:!1,collision:!1,gridMetrics:{...d.gridMetrics,cols:o,rows:i}})),x.clear()},commit(){const t=S({subscribe:r});t.tabId&&(k.saveLayout(t.tabId,t.drafts,t.cardEntities,t.templateOverrides),this.reset())},cancel(){this.reset()},reset(){a(v),x.clear()},toggleGridSettings(){n(t=>({...t,showGridSettings:!t.showGridSettings}))},selectCard(t){n(s=>({...s,selectedCardId:t}))},setGridMetrics(t,s,e){n(o=>o.gridMetrics.halfUnitSizePx===t&&o.gridMetrics.cols===s&&o.gridMetrics.rows===e?o:{...o,gridMetrics:{halfUnitSizePx:t,cols:s,rows:e}})},updateDraft(t,s){n(e=>{const o=new Map(e.drafts);o.set(t,s);const i=R(s,e.gridMetrics.cols,e.gridMetrics.rows),d=[];o.forEach((w,u)=>{u!==t&&d.push(w)});const c=H(s,d);return{...e,drafts:o,collision:!i||c}})},setCardTemplate(t,s){n(e=>{const o=new Map(e.templateOverrides);return o.set(t,s),{...e,templateOverrides:o}})},addCard(t){n(s=>{if(!s.tabId)return s;const e=s.gridMetrics.cols,o=s.gridMetrics.rows;let i=0,d=0,c=!1;const w=1,u=1;for(let l=0;l<o;l++){for(let p=0;p<e;p++){const m={col:p,row:l,w,h:u};let C=!1;for(const g of s.drafts.values())if(m.col<g.col+g.w&&m.col+m.w>g.col&&m.row<g.row+g.h&&m.row+m.h>g.row){C=!0;break}if(!C){i=p,d=l,c=!0;break}}if(c)break}if(!c){let l=0;s.drafts.forEach(p=>l=Math.max(l,p.row+p.h)),d=Math.max(0,Math.ceil(l)),i=0}const f=`card_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,h=new Map(s.drafts);h.set(f,{col:i,row:d,w:1,h:1});const y=new Map(s.cardEntities);return y.set(f,t),{...s,drafts:h,cardEntities:y,selectedCardId:f,collision:!1}})},deleteCard(t){n(s=>{const e=new Map(s.drafts),o=new Map(s.cardEntities),i=new Map(s.templateOverrides);return e.delete(t),o.delete(t),i.delete(t),{...s,drafts:e,cardEntities:o,templateOverrides:i,selectedCardId:null}})},clearAllCards(){n(t=>({...t,drafts:new Map,cardEntities:new Map,templateOverrides:new Map,selectedCardId:null}))},duplicateCard(t){const s=S(E);n(e=>{var y;if(!e.tabId)return e;const o=e.drafts.get(t),i=e.cardEntities.get(t);if(!o||!i)return e;let d=e.templateOverrides.get(t);if(d===void 0){const l=(y=s.tabs[e.tabId])==null?void 0:y.cards.find(p=>p.id===t);d=l==null?void 0:l.templateId}const c=`card_${Date.now()}`,w={...o,col:o.col,row:o.row+o.h},u=new Map(e.drafts),f=new Map(e.cardEntities),h=new Map(e.templateOverrides);return u.set(c,w),f.set(c,i),d&&h.set(c,d),{...e,drafts:u,cardEntities:f,templateOverrides:h,selectedCardId:c}})},moveCardToTab(t,s){const e=S({subscribe:r});if(!e.tabId||!e.drafts.has(t))return;const o=e.cardEntities.get(t);o&&(E.addCard(s,o),this.deleteCard(t))},pushHistory(t,s,e){const o=S({subscribe:r});o.tabId&&x.push({type:"transform",tabId:o.tabId,cardId:t,from:s,to:e})},undo(){const t=x.undo();t&&n(s=>{const e=new Map(s.drafts);return e.set(t.cardId,t.from),{...s,drafts:e,selectedCardId:t.cardId,collision:!1}})},redo(){const t=x.redo();t&&n(s=>{const e=new Map(s.drafts);return e.set(t.cardId,t.to),{...s,drafts:e,selectedCardId:t.cardId,collision:!1}})}}}const $=z();export{P as a,W as b,x as c,$ as e};
